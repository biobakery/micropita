<?xml version="1.0"?>

<tool name="Load data for microPITA" id="micropita_input" version="1.0">
  <description>
  </description>
  <action module="galaxy.tools.actions.upload" class="UploadToolAction"/>
  <command interpreter="python">
      $GALAXY_ROOT_DIR/tools/micropita/galaxy/upload.py $GALAXY_ROOT_DIR $GALAXY_DATATYPES_CONF_FILE $paramfile
    #set $outnum = 0
    #while $varExists('output%i' % $outnum):
        #set $output = $getVar('output%i' % $outnum)
        #set $outnum += 1
        #set $file_name = $output.file_name
        ## FIXME: This is not future-proof for other uses of external_filename (other than for use by the library upload's "link data" feature)
        #if $output.dataset.dataset.external_filename:
            #set $file_name = "None"
        #end if
        ${output.dataset.dataset.id}:${output.files_path}:${file_name}
    #end while
  </command>
  <inputs nginx_upload="true">
    <param name="file_type" type="hidden" label="File Format" value="micropita" />
    <param name="async_datasets" type="hidden" value="None"/>
    <upload_dataset name="files" title="Specify Files for Dataset" file_type_name="file_type" metadata_ref="files_metadata">
      <param name="file_data" type="file" size="30" label="Input PCL file" ajax-upload="true" help="TIP: A example file can be found at the URL https://bytebucket.org/timothyltickle/micropita/wiki/micropita_sample_PCL.txt">
        <validator type="expression" message="You will need to reselect the file you specified (%s)." substitute_value_in_message="True">not ( ( isinstance( value, unicode ) or isinstance( value, str ) ) and value != "" )</validator> <!-- use validator to post message to user about needing to reselect the file, since most browsers won't accept the value attribute for file inputs -->
      </param>
      <param name="url_paste" type="text" area="true" size="5x35" label="Enter URL or file text here" help="Here you may specify a list of URLs (one per line) or paste the contents of a file."/> 
      <param name="ftp_files" type="ftpfile" label="Files uploaded via FTP"/>
      <param name="space_to_tab" type="hidden" display="checkboxes" value="Yes" multiple="True" /> 
    </upload_dataset>
    <conditional name="files_metadata" title="Specify metadata" value_from="self:app.datatypes_registry.get_upload_metadata_params" value_ref="file_type" value_ref_in_group="False" />
    <!-- <param name="other_dbkey" type="text" label="Or user-defined Genome" /> -->
  </inputs>
  <help>


microbiome: Picking Interesting Taxonomic Abundance
---------------------------------------------------

microPITA is a computational tool enabling sample selection in tiered studies. Using tiered-study designs can more efficiently allocate resources, reducing study costs, and maximizing the use of samples. From a survey study, selection of samples can be performed to target various microbial communities including:

1. Samples with the most diverse community (maximum diversity);
2. Samples dominated by specific microbes (targeted feature);
3. Samples with microbial communities representative of the survey (representative dissimilarity);
4. Samples with the most extreme microbial communities in the survey (most dissimilar);
5. Given a phenotype (like disease state), samples at the border of phenotypes (discriminant) or samples typical of each phenotype (distinct). 

Additionally, methods can leverage clinical metadata by stratifying samples into groups in which samples are subsequently selected. This enables the use of microPITA in cohort studies.

.. image:: ../galaxy/static/images/HMPStool10PCoA.png

MicroPITA unsupervised method selection in the HMP 16S Gut Microbiome. Selection of 10 samples using targeted feature targeting *Bacteroides* (blue), maximum diversity (orange), representative dissimilarity (purple), and most dissimilar (pink) using Principle Covariance Analysis (PCoA) for ordination. Targeted feature selects samples dominated by *Bacteroides* (upper left) while maximum diversity select more diverse samples away from *Bacteroides* dominant samples. Representative selection selects samples covering the range of samples in the PCoA plot focusing on the higher density central region while maximum dissimilarity selects samples at the periphery of the plot.

Required inputs
---------------

microPITA requires an input pcl file of metadata and microbial community measurements. Although some defaults can be changed, microPITA expects a PCL file as an input file. A PCL file is a text delimited file similar to an excel spread sheet with the following characteristics.

1. **Rows** represent metadata and features (bugs), **columns** represent samples.
2. The **first row** by default should be the sample ids.
3. Metadata rows should be next.
4. Lastly, rows containing features (bugs) measurements (like abundance) should be after metadata rows.
5. The **first column** should contain the ID describing the column. For metadata this may be, for example, "Age" for a row containing the age of the patients donating the samples. For measurements, this should be the feature name (bug name).
6. The file is expected to be TAB delimited.
7. If a consensus lineage or hierarchy of taxonomy is contained in the feature name, the default delimiter between clades is the pipe ("|").

**Note** MAC users, please save file as windows formatted text.

.. image:: ../galaxy/static/images/pcl_diagram.png

An example can be found at https://bytebucket.org/timothyltickle/micropita/wiki/micropita_sample_PCL.txt




Outputs
-------

The Run MicroPITA module will create one output text file. The output will consist of one line starting with a key word for the selection method and then followed by selected samples delimited by tabs. An example of 6 samples selected by the representative:

representative	sample_1	sample_2	sample_3	sample_4	sample_5	sample_6


Acknowledgments
---------------
Special thanks to Eric Franzosa for developing the above PCL figure!


Citation and Contacts
---------------------
For more information please visit http://huttenhower.sph.harvard.edu/micropita

When using MicroPITA please cite:
Tickle T, Segata N, Waldron L, Weingart G, Huttenhower C. Two-stage microbial community experimental design. (Under review)

Please feel free to contact us at ttickle@hsph.harvard.edu  for any questions or comments!
  </help>
</tool>
